#!/usr/bin/env ruby
# frozen_string_literal: true

# Update the Gem Family section in all README files that contain it.
#
# This is a convenience wrapper around exe/ast-merge-recipe that runs
# the gem_family_section recipe, then fixes any formatting issues.
#
# Usage: bin/update_gem_family_section [options] [files...]
#
# If no files specified, processes README.md and all vendor/*/README.md files.
#
# Options:
#   -n, --dry-run    Show what would be changed without writing files
#   -v, --verbose    Show detailed merge information
#   -h, --help       Show this help message
#   --skip-fix       Skip the formatting fix step (only run recipe)

require "optparse"

options = {
  dry_run: false,
  verbose: false,
  skip_fix: false,
}

parser = OptionParser.new do |opts|
  opts.banner = "Usage: #{$PROGRAM_NAME} [options] [files...]"

  opts.on("-n", "--dry-run", "Show what would be changed without writing files") do
    options[:dry_run] = true
  end

  opts.on("-v", "--verbose", "Show detailed merge information") do
    options[:verbose] = true
  end

  opts.on("--skip-fix", "Skip the formatting fix step (only run recipe)") do
    options[:skip_fix] = true
  end

  opts.on("-h", "--help", "Show this help message") do
    puts opts
    exit
  end
end

parser.parse!

# Determine paths
script_dir = File.expand_path("..", __dir__)
exe_path = File.join(script_dir, "exe", "ast-merge-recipe")
recipe_path = File.join(script_dir, ".merge-recipes", "gem_family_section.yml")
fix_script = File.join(script_dir, "bin", "fix_readme_formatting")

# Validate paths exist
unless File.exist?(exe_path)
  warn "ERROR: exe/ast-merge-recipe not found at #{exe_path}"
  exit 1
end

unless File.exist?(recipe_path)
  warn "ERROR: Recipe not found at #{recipe_path}"
  exit 1
end

# Determine which files to process (remaining args after option parsing)
files = if ARGV.empty?
  ["README.md"] + Dir.glob("vendor/*/README.md")
else
  ARGV
end

# Build recipe runner arguments
recipe_args = [recipe_path]
recipe_args << "-n" if options[:dry_run]
recipe_args << "-v" if options[:verbose]
recipe_args.concat(files)

# Execute the recipe runner
system(exe_path, *recipe_args)
merge_status = $?.exitstatus

# Run the formatting fix script if merge succeeded and fix script exists
if merge_status == 0 && !options[:skip_fix] && File.exist?(fix_script)
  fix_args = []
  fix_args << "-n" if options[:dry_run]
  fix_args << "-v" if options[:verbose]
  fix_args.concat(files)

  puts "\nFixing README formatting..." if options[:verbose]
  system(fix_script, *fix_args)
end

exit merge_status
