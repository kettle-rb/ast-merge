<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: TREE_SITTER_SETUP_FIXES
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "TREE_SITTER_SETUP_FIXES";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: TREE_SITTER_SETUP_FIXES</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="tree-sitter-setup-script-fixes---summary">Tree-Sitter Setup Script Fixes - Summary</h1>

<h2 id="problem">Problem</h2>

<p>The tree-sitter setup scripts had a critical bug in argument parsing that broke GitHub Actions workflows. The scripts used <code>for arg in "$@"</code> with <code>shift</code> commands, which doesn’t work properly because <code>shift</code> doesn’t affect the loop iteration.</p>

<p>Additionally, the scripts required manual <code>--sudo</code> flag management, making them less flexible across different environments.</p>

<h2 id="solution">Solution</h2>

<ol>
  <li>
<strong>Fixed argument parsing</strong>: Replaced <code>for arg in "$@"</code> with <code>while [[ $# -gt 0 ]]</code> loop</li>
  <li>
<strong>Added auto-detection</strong>: Script now automatically detects if running as root and sets sudo accordingly</li>
  <li>
<strong>Improved documentation</strong>: Added comments explaining dual-environment design</li>
  <li>
<strong>Updated workspace parameter</strong>: Clarified it’s informational only</li>
</ol>

<h2 id="changes-made">Changes Made</h2>

<h3 id="core-script-fixes-4-gems">Core Script Fixes (4 gems)</h3>

<p><strong>Files fixed:</strong></p>
<ul>
  <li><code>vendor/toml-merge/.github/scripts/ubuntu/setup-tree-sitter.sh</code></li>
  <li><code>vendor/json-merge/.github/scripts/ubuntu/setup-tree-sitter.sh</code></li>
  <li><code>vendor/jsonc-merge/.github/scripts/ubuntu/setup-tree-sitter.sh</code></li>
  <li><code>vendor/bash-merge/.github/scripts/ubuntu/setup-tree-sitter.sh</code></li>
</ul>

<p><strong>Key changes:</strong></p>
<pre class="code language-bash"><code class="language-bash"># BEFORE (broken)
for arg in &quot;$@&quot;; do
  case $arg in
    --sudo)
      SUDO=&quot;sudo&quot;
      shift  # Doesn&#39;t work in for loop!
      ;;
  esac
done

# AFTER (fixed)
while [[ $# -gt 0 ]]; do
  case $1 in
    --sudo)
      SUDO=&quot;sudo&quot;
      shift  # Works correctly in while loop
      ;;
  esac
done

# Auto-detect if we need sudo (running as non-root)
if [ -z &quot;$SUDO&quot; ] &amp;&amp; [ &quot;$(id -u)&quot; -ne 0 ]; then
  SUDO=&quot;sudo&quot;
fi
</code></pre>

<h3 id="workflow-updates-toml-merge-only">Workflow Updates (toml-merge only)</h3>

<p><strong>Files updated to remove explicit –sudo flag:</strong></p>
<ul>
  <li><code>vendor/toml-merge/.github/workflows/current.yml</code></li>
  <li><code>vendor/toml-merge/.github/workflows/supported.yml</code></li>
  <li><code>vendor/toml-merge/.github/workflows/heads.yml</code></li>
  <li><code>vendor/toml-merge/.github/workflows/dep-heads.yml</code></li>
  <li><code>vendor/toml-merge/.github/workflows/coverage.yml</code></li>
  <li><code>vendor/toml-merge/.github/workflows/locked_deps.yml</code></li>
  <li><code>vendor/toml-merge/.github/workflows/unlocked_deps.yml</code></li>
  <li><code>vendor/toml-merge/.github/workflows/truffle.yml</code></li>
</ul>

<p><strong>Change:</strong></p>
<pre class="code language-yaml"><code class="language-yaml"># BEFORE
- name: Install tree-sitter dependencies (Ubuntu)
  run: .github/scripts/ubuntu/setup-tree-sitter.sh --sudo

# AFTER
- name: Install tree-sitter dependencies (Ubuntu)
  run: .github/scripts/ubuntu/setup-tree-sitter.sh
</code></pre>

<p><strong>Note</strong>: json-merge, jsonc-merge, and bash-merge workflows don’t use the setup script in GHA (they install libtree-sitter-dev directly), so no workflow changes were needed for those gems.</p>

<h3 id="devcontainer-updates-4-gems">Devcontainer Updates (4 gems)</h3>

<p><strong>Files updated:</strong></p>
<ul>
  <li><code>vendor/toml-merge/.devcontainer/devcontainer.json</code></li>
  <li><code>vendor/json-merge/.devcontainer/devcontainer.json</code></li>
  <li><code>vendor/jsonc-merge/.devcontainer/devcontainer.json</code></li>
  <li><code>vendor/bash-merge/.devcontainer/devcontainer.json</code></li>
</ul>

<p><strong>Change:</strong></p>
<pre class="code language-json"><code class="language-json">// BEFORE
&quot;postCreateCommand&quot;: &quot;bash ${containerWorkspaceFolder}/.github/scripts/ubuntu/setup-tree-sitter.sh --sudo --workspace=${containerWorkspaceFolder} &amp;&amp; bundle update --bundler&quot;

// AFTER
&quot;postCreateCommand&quot;: &quot;bash ${containerWorkspaceFolder}/.github/scripts/ubuntu/setup-tree-sitter.sh --workspace=${containerWorkspaceFolder} &amp;&amp; bundle update --bundler&quot;
</code></pre>

<h3 id="documentation">Documentation</h3>

<p><strong>New file created:</strong></p>
<ul>
  <li><code>vendor/toml-merge/.github/scripts/ubuntu/README.md</code></li>
</ul>

<p>Comprehensive documentation covering:</p>
<ul>
  <li>Dual-environment design</li>
  <li>Auto-detection mechanism</li>
  <li>Usage examples</li>
  <li>Troubleshooting guide</li>
  <li>Common issues and solutions</li>
  <li>Argument parsing fix explanation</li>
</ul>

<h2 id="testing-plan">Testing Plan</h2>

<h3 id="1-test-in-github-actions">1. Test in GitHub Actions</h3>

<p><strong>For toml-merge:</strong></p>
<pre class="code language-bash"><code class="language-bash"># Trigger a workflow manually or create a PR
# Check that setup-tree-sitter.sh runs successfully
# Verify tests pass with tree-sitter libraries available
</code></pre>

<p><strong>For other gems:</strong></p>
<pre class="code language-bash"><code class="language-bash"># json-merge, jsonc-merge, bash-merge already work in GHA
# (they don&#39;t use the setup script in workflows)
# No changes needed to GHA for these gems
</code></pre>

<h3 id="2-test-in-devcontainer">2. Test in Devcontainer</h3>

<p><strong>All 4 gems (toml-merge, json-merge, jsonc-merge, bash-merge):</strong></p>
<pre class="code language-bash"><code class="language-bash"># Rebuild devcontainer
# Verify postCreateCommand runs successfully
# Check library installation:
ldconfig -p | grep libtree-sitter
ls -lh /usr/local/lib/libtree-sitter-{toml,json,jsonc,bash}.so

# Test with Ruby:
ruby -e &quot;require &#39;bundler/setup&#39;; require &#39;tree_haver&#39;; puts TreeHaver::GrammarFinder.new(:toml).find_library_path&quot;
</code></pre>

<h3 id="3-manual-script-testing">3. Manual Script Testing</h3>

<pre class="code language-bash"><code class="language-bash"># As root (should auto-detect, no sudo prefix)
cd vendor/toml-merge
sudo bash .github/scripts/ubuntu/setup-tree-sitter.sh

# As non-root (should auto-detect, use sudo)
bash .github/scripts/ubuntu/setup-tree-sitter.sh

# With explicit flag (should work either way)
bash .github/scripts/ubuntu/setup-tree-sitter.sh --sudo
</code></pre>

<h2 id="benefits">Benefits</h2>

<ol>
  <li>
<strong>Fixes GHA failures</strong>: Proper argument parsing means scripts work in workflows</li>
  <li>
<strong>Simpler usage</strong>: No need to remember <code>--sudo</code> flag, auto-detected</li>
  <li>
<strong>Better maintainability</strong>: Shared scripts work identically in all environments</li>
  <li>
<strong>Easier debugging</strong>: Can test GHA-like environment locally in devcontainer</li>
  <li>
<strong>Clear documentation</strong>: README explains how everything works</li>
</ol>

<h2 id="backward-compatibility">Backward Compatibility</h2>

<ul>
  <li>The <code>--sudo</code> flag still works (explicitly sets sudo even if running as root)</li>
  <li>The <code>--workspace</code> flag still accepted (informational only, doesn’t break existing callers)</li>
  <li>No breaking changes to the API</li>
</ul>

<h2 id="files-summary">Files Summary</h2>

<p><strong>Total files modified: 45</strong></p>
<ul>
  <li>11 setup-tree-sitter.sh scripts:
    <ul>
      <li>4 single-grammar scripts (toml-merge, json-merge, jsonc-merge, bash-merge)</li>
      <li>7 multi-grammar scripts (ast-merge, tree_haver, commonmarker-merge, markdown-merge, markly-merge, kettle-dev, kettle-jem)</li>
    </ul>
  </li>
  <li>8 workflow files (toml-merge only)</li>
  <li>11 devcontainer.json files (all gems)</li>
  <li>1 new README.md (documentation)</li>
</ul>

<p><strong>Gems affected:</strong></p>

<p><strong>Single-Grammar Gems</strong> (direct tree-sitter usage):</p>
<ul>
  <li>toml-merge (tree-sitter-toml)</li>
  <li>json-merge (tree-sitter-json)</li>
  <li>jsonc-merge (tree-sitter-jsonc)</li>
  <li>bash-merge (tree-sitter-bash)</li>
</ul>

<p><strong>Multi-Grammar Gems</strong> (integration testing / fenced code blocks):</p>
<ul>
  <li>ast-merge (all grammars for integration testing)</li>
  <li>tree_haver (all grammars for integration testing)</li>
  <li>commonmarker-merge (all grammars for fenced code blocks)</li>
  <li>markdown-merge (all grammars for fenced code blocks)</li>
  <li>markly-merge (all grammars for fenced code blocks)</li>
  <li>kettle-dev (all grammars for top-level merging tool)</li>
  <li>kettle-jem (all grammars for recipe testing)</li>
</ul>

<h2 id="next-steps">Next Steps</h2>

<ol>
  <li>
<strong>User testing</strong>: Ask user to verify the changes by running:
    <ul>
      <li>A GHA workflow in toml-merge (e.g., trigger current.yml manually)</li>
      <li>Copy/paste output to confirm success</li>
    </ul>
  </li>
  <li>
<strong>Devcontainer verification</strong>: If user has access to devcontainer:
    <ul>
      <li>Rebuild container for any of the 4 gems</li>
      <li>Verify tree-sitter libraries are installed</li>
      <li>Run tests to confirm everything works</li>
    </ul>
  </li>
  <li>
    <p><strong>Monitor for issues</strong>: Watch for any new GHA failures or devcontainer issues</p>
  </li>
  <li>
<strong>Consider further improvements</strong>:
    <ul>
      <li>Add verification step to GHA workflows (check for expected .so files)</li>
      <li>Consolidate devcontainer setup (reduce redundancy between apt-install and postCreate)</li>
      <li>Add CI job specifically for testing the setup script</li>
    </ul>
  </li>
</ol>
</div></div>

      <div id="footer">
  Generated on Sun Dec 28 18:06:57 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.0).
</div>

    </div>
  </body>
</html>