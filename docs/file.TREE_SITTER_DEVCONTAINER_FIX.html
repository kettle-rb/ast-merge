<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: TREE_SITTER_DEVCONTAINER_FIX
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "TREE_SITTER_DEVCONTAINER_FIX";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: TREE_SITTER_DEVCONTAINER_FIX</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="tree-sitter-devcontainer-setup-fix">Tree-Sitter Devcontainer Setup Fix</h1>

<h2 id="problem">Problem</h2>

<p>The tree-sitter setup was failing in devcontainers because the <code>install.sh</code> script (which runs during the <strong>build phase</strong>) was trying to locate and execute the <code>setup-tree-sitter.sh</code> script from the workspace. However, the workspace is not mounted yet during the build phase - it only becomes available during the <code>postCreateCommand</code> phase after the container is created.</p>

<p>Error seen:</p>
<pre class="code ruby"><code class="ruby">ERROR: Cannot find setup-tree-sitter.sh in any expected location
Tried:
  /IdeaProjects/toml-merge/.github/scripts/ubuntu/setup-tree-sitter.sh
  /workspaces/toml-merge/.github/scripts/ubuntu/setup-tree-sitter.sh
  ...
</code></pre>

<h2 id="solution">Solution</h2>

<p><strong>Removed tree-sitter setup from the devcontainer feature’s <code>install.sh</code></strong> and kept it only in the <code>postCreateCommand</code> where the workspace is already mounted.</p>

<h3 id="changes-made">Changes Made</h3>

<p>Modified <code>.devcontainer/apt-install/install.sh</code> in all affected gems to:</p>
<ol>
  <li>Install only basic apt packages during build phase</li>
  <li>Add clear comment explaining that tree-sitter setup happens in postCreateCommand</li>
  <li>Remove all the workspace path detection logic</li>
</ol>

<p>The <code>devcontainer.json</code> files already had the correct <code>postCreateCommand</code>:</p>
<pre class="code language-json"><code class="language-json">&quot;postCreateCommand&quot;: &quot;bash ${containerWorkspaceFolder}/.github/scripts/ubuntu/setup-tree-sitter.sh --workspace=${containerWorkspaceFolder} &amp;&amp; bundle update --bundler&quot;
</code></pre>

<h2 id="affected-gems">Affected Gems</h2>

<p>Fixed in the following gems (all vendored in ast-merge):</p>

<ol>
  <li>
<strong>bash-merge</strong> - tree-sitter-bash</li>
  <li>
<strong>commonmarker-merge</strong> - multiple grammars for fenced code blocks</li>
  <li>
<strong>json-merge</strong> - tree-sitter-json</li>
  <li>
<strong>jsonc-merge</strong> - tree-sitter-jsonc</li>
  <li>
<strong>kettle-dev</strong> - multiple grammars for top-level merging tool</li>
  <li>
<strong>kettle-jem</strong> - multiple grammars for recipe testing</li>
  <li>
<strong>markdown-merge</strong> - multiple grammars for fenced code blocks</li>
  <li>
<strong>markly-merge</strong> - multiple grammars for fenced code blocks</li>
  <li>
<strong>toml-merge</strong> - tree-sitter-toml</li>
  <li>
<strong>tree_haver</strong> - multiple grammars for integration testing</li>
</ol>

<h2 id="architecture">Architecture</h2>

<h3 id="build-phase-runs-as-root-before-workspace-mount">Build Phase (runs as root before workspace mount)</h3>
<ul>
  <li>
<code>.devcontainer/apt-install/install.sh</code> runs</li>
  <li>Installs system packages (direnv, JDK, build tools, etc.)</li>
  <li>
<strong>Does NOT install tree-sitter</strong> (workspace not available)</li>
</ul>

<h3 id="post-create-phase-runs-after-workspace-mount">Post-Create Phase (runs after workspace mount)</h3>
<ul>
  <li>
<code>postCreateCommand</code> runs from <code>devcontainer.json</code>
</li>
  <li>Executes <code>setup-tree-sitter.sh</code> from workspace</li>
  <li>Auto-detects sudo requirement</li>
  <li>Installs tree-sitter runtime and grammar(s)</li>
  <li>Runs <code>bundle update --bundler</code>
</li>
</ul>

<h2 id="github-actions-compatibility">GitHub Actions Compatibility</h2>

<p>The <code>setup-tree-sitter.sh</code> script continues to work in GitHub Actions workflows because:</p>
<ul>
  <li>GHA workflows have the workspace checked out before running scripts</li>
  <li>The script auto-detects the need for sudo (GHA runs as non-root)</li>
  <li>No changes were needed to the <code>setup-tree-sitter.sh</code> script itself</li>
</ul>

<h2 id="testing">Testing</h2>

<p>To test in devcontainer:</p>
<ol>
  <li>Open project in JetBrains IDE with devcontainer support</li>
  <li>Wait for devcontainer build to complete</li>
  <li>Verify tree-sitter libraries are installed: <code>ls -la /usr/local/lib/libtree-sitter-*.so</code>
</li>
  <li>Run tests to confirm tree-sitter functionality</li>
</ol>

<h2 id="notes">Notes</h2>

<ul>
  <li>The <code>--workspace</code> parameter passed to <code>setup-tree-sitter.sh</code> is informational/debugging only</li>
  <li>The script doesn’t actually need the workspace path to function (it just builds and installs system libraries)</li>
  <li>This fix maintains consistency between devcontainer and GHA environments</li>
</ul>
</div></div>

      <div id="footer">
  Generated on Sun Dec 28 16:56:12 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.0).
</div>

    </div>
  </body>
</html>