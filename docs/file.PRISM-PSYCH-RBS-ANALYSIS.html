<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: PRISM-PSYCH-RBS-ANALYSIS
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "PRISM-PSYCH-RBS-ANALYSIS";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: PRISM-PSYCH-RBS-ANALYSIS</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="analysis-prismpsychrbs-merge-vs-treehaver-backends">Analysis: Prism/Psych/RBS-Merge vs TreeHaver Backends</h1>

<p><strong>Date:</strong> December 20, 2025<br>
<strong>Purpose:</strong> Evaluate whether prism-merge, psych-merge, and rbs-merge should use TreeHaver backends</p>

<h2 id="executive-summary">Executive Summary</h2>

<p><strong>Conclusion:</strong> These three gems should <strong>NOT</strong> be migrated to use TreeHaver backends at this time.</p>

<p><strong>Reasons:</strong></p>
<ol>
  <li>TreeHaver’s backends are <strong>thin wrappers</strong> for API compatibility, not full-featured merge infrastructure</li>
  <li>The *-merge gems provide <strong>domain-specific merge logic</strong> that goes far beyond parsing</li>
  <li>TreeHaver backends don’t provide freeze block detection, comment tracking, or merge-specific features</li>
  <li>Migration would provide <strong>minimal benefit</strong> while risking functionality loss</li>
</ol>

<hr>

<h2 id="detailed-analysis">Detailed Analysis</h2>

<h3 id="1-treehavers-backend-philosophy">1. TreeHaver’s Backend Philosophy</h3>

<p>TreeHaver backends are designed to:</p>
<ul>
  <li>✅ Provide a <strong>unified parsing API</strong> across different parsers (tree-sitter, Prism, Psych, etc.)</li>
  <li>✅ Normalize node access patterns (<code>type</code>, <code>children</code>, <code>text</code>, etc.)</li>
  <li>✅ Enable <strong>backend switching</strong> for performance or compatibility</li>
  <li>❌ <strong>NOT</strong> provide merge-specific functionality</li>
  <li>❌ <strong>NOT</strong> handle freeze blocks</li>
  <li>❌ <strong>NOT</strong> track comments for merging purposes</li>
</ul>

<h3 id="2-what--merge-gems-provide-beyond-parsing">2. What *-Merge Gems Provide Beyond Parsing</h3>

<h4 id="prism-merge">prism-merge</h4>
<p><strong>Merge-Specific Features:</strong></p>
<ul>
  <li>Freeze block detection via comment scanning</li>
  <li>
<code>attach_comments_safely!</code> for JRuby compatibility</li>
  <li>
<code>frozen_node?</code> logic with freeze marker patterns</li>
  <li>
<code>FrozenWrapper</code> integration with <code>Ast::Merge::Freezable</code>
</li>
  <li>Method-level signature generation for matching</li>
  <li>Ruby-specific merge strategies (classes, modules, methods)</li>
</ul>

<p><strong>TreeHaver Backend Provides:</strong></p>
<ul>
  <li>Basic parsing: <code>Prism.parse(source)</code>
</li>
  <li>Node wrapper with <code>type</code>, <code>children</code>, <code>text</code>
</li>
  <li>Error access via <code>parse_result.errors</code>
</li>
</ul>

<p><strong>Gap:</strong> TreeHaver doesn’t handle freeze blocks, comment-based markers, or Ruby-specific merge logic.</p>

<hr>

<h4 id="psych-merge">psych-merge</h4>
<p><strong>Merge-Specific Features:</strong></p>
<ul>
  <li>Freeze block extraction from YAML comments</li>
  <li>
<code>CommentTracker</code> for preserving comments during merge</li>
  <li>
<code>NodeWrapper</code> for YAML-specific node operations</li>
  <li>
<code>mapping_entries</code> extraction for key-value merging</li>
  <li>YAML-specific signature generation (key paths, types)</li>
  <li>
<code>MappingMatchRefiner</code> for intelligent mapping merges</li>
</ul>

<p><strong>TreeHaver Backend Provides:</strong></p>
<ul>
  <li>Basic parsing: <code>Psych.parse_stream(source)</code>
</li>
  <li>Node wrapper with <code>type</code>, <code>children</code>, <code>text</code>
</li>
  <li>
<strong>No comment preservation</strong> (TreeHaver’s Psych backend returns <code>comments = []</code>)</li>
</ul>

<p><strong>Gap:</strong> TreeHaver doesn’t preserve comments in YAML (Psych doesn’t support this natively), and doesn’t provide merge-specific logic.</p>

<hr>

<h4 id="rbs-merge">rbs-merge</h4>
<p><strong>Merge-Specific Features:</strong></p>
<ul>
  <li>Freeze block detection in RBS comments</li>
  <li>RBS-specific signature generation (class names, method signatures, types)</li>
  <li>Declaration-level merging (classes, modules, interfaces, type aliases)</li>
  <li>Member-level merging (methods, attributes, includes)</li>
  <li>RBS-specific conflict resolution</li>
</ul>

<p><strong>TreeHaver Backend:</strong></p>
<ul>
  <li>
<strong>DOES NOT EXIST</strong> - TreeHaver has no RBS backend</li>
  <li>Would need to be created from scratch</li>
</ul>

<p><strong>Gap:</strong> TreeHaver doesn’t support RBS at all.</p>

<hr>

<h2 id="comparison-matrix">Comparison Matrix</h2>

<table>
  <thead>
    <tr>
      <th>Feature</th>
      <th>prism-merge</th>
      <th>TreeHaver::Backends::Prism</th>
      <th>psych-merge</th>
      <th>TreeHaver::Backends::Psych</th>
      <th>rbs-merge</th>
      <th>TreeHaver RBS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Parsing</strong></td>
      <td>Prism.parse</td>
      <td>✅ Wrapped</td>
      <td>Psych.parse_stream</td>
      <td>✅ Wrapped</td>
      <td>RBS::Parser</td>
      <td>❌ Not exists</td>
    </tr>
    <tr>
      <td><strong>Freeze Blocks</strong></td>
      <td>✅ Full support</td>
      <td>❌ None</td>
      <td>✅ Full support</td>
      <td>❌ None</td>
      <td>✅ Full support</td>
      <td>❌ N/A</td>
    </tr>
    <tr>
      <td><strong>Comment Tracking</strong></td>
      <td>✅ Via Prism native</td>
      <td>❌ Passthrough only</td>
      <td>✅ CommentTracker</td>
      <td>❌ Returns empty</td>
      <td>✅ Full support</td>
      <td>❌ N/A</td>
    </tr>
    <tr>
      <td><strong>Signature Generation</strong></td>
      <td>✅ Ruby-specific</td>
      <td>❌ None</td>
      <td>✅ YAML-specific</td>
      <td>❌ None</td>
      <td>✅ RBS-specific</td>
      <td>❌ N/A</td>
    </tr>
    <tr>
      <td><strong>Merge Logic</strong></td>
      <td>✅ Full</td>
      <td>❌ None</td>
      <td>✅ Full</td>
      <td>❌ None</td>
      <td>✅ Full</td>
      <td>❌ N/A</td>
    </tr>
    <tr>
      <td><strong>Node Wrapping</strong></td>
      <td>Custom for merge</td>
      <td>Generic for parsing</td>
      <td>Custom for merge</td>
      <td>Generic for parsing</td>
      <td>Custom for merge</td>
      <td>❌ N/A</td>
    </tr>
  </tbody>
</table>

<hr>

<h2 id="what-would-migration-look-like">What Would Migration Look Like?</h2>

<h3 id="if-we-migrated-prism-merge-to-treehaver">If we migrated prism-merge to TreeHaver:</h3>

<pre class="code language-ruby"><code class="language-ruby"># Current (direct Prism usage):
@parse_result = Prism.parse(source)
@parse_result.attach_comments!

# After (using TreeHaver):
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Backends::Prism::Language.ruby
tree = parser.parse(source)
parse_result = tree.parse_result  # Access underlying Prism::ParseResult
parse_result.attach_comments!     # Still need to do this ourselves
</code></pre>

<p><strong>Benefit:</strong> Backend switching capability (but there’s no alternative Ruby parser)<br>
<strong>Cost:</strong> Extra layer of wrapping, no actual functionality gain</p>

<h3 id="if-we-migrated-psych-merge-to-treehaver">If we migrated psych-merge to TreeHaver:</h3>

<pre class="code language-ruby"><code class="language-ruby"># Current (direct Psych usage):
@ast = Psych.parse_stream(source)
@comment_tracker = CommentTracker.new(source)  # Our custom solution

# After (using TreeHaver):
parser = TreeHaver::Parser.new
parser.language = TreeHaver::Backends::Psych::Language.yaml
tree = parser.parse(source)
@ast = tree.inner_tree  # Access underlying Psych::Nodes::Stream
@comment_tracker = CommentTracker.new(source)  # Still need this
</code></pre>

<p><strong>Benefit:</strong> Backend switching (but there’s no alternative YAML parser)<br>
<strong>Cost:</strong> Extra layer, no comment support from TreeHaver</p>

<h3 id="if-we-migrated-rbs-merge-to-treehaver">If we migrated rbs-merge to TreeHaver:</h3>

<p><strong>Problem:</strong> TreeHaver doesn’t have an RBS backend! We’d need to:</p>
<ol>
  <li>Create <code>TreeHaver::Backends::RBS</code> from scratch</li>
  <li>Wrap RBS::Parser, RBS::Buffer, RBS::AST::*</li>
  <li>Provide TreeHaver-compatible Node interface</li>
  <li>Test across all Ruby implementations</li>
</ol>

<p><strong>Benefit:</strong> Consistency with other TreeHaver backends<br>
<strong>Cost:</strong> Significant development effort, unclear value</p>

<hr>

<h2 id="key-insights">Key Insights</h2>

<h3 id="1-treehaver-is-for-parsing-abstraction-not-merge-logic">1. TreeHaver is for <strong>Parsing Abstraction</strong>, not <strong>Merge Logic</strong>
</h3>

<p>TreeHaver solves the problem: “How do I parse code with different backends?”</p>

<p>It does <strong>NOT</strong> solve: “How do I merge code intelligently?”</p>

<p>The *-merge gems provide the merge intelligence. TreeHaver just helps with parsing.</p>

<h3 id="2-for-tree-sitter-grammars-treehaver-is-essential">2. For Tree-Sitter Grammars, TreeHaver is Essential</h3>

<p>For languages that use tree-sitter grammars (TOML, Bash, JSON, JSONC), TreeHaver provides:</p>
<ul>
  <li>Grammar discovery (<code>GrammarFinder</code>)</li>
  <li>Path validation and security</li>
  <li>Multi-backend support (MRI, Rust, FFI, Java, Citrus fallback)</li>
  <li>Centralized grammar loading</li>
</ul>

<p><strong>This is why we migrated</strong> toml-merge, bash-merge, json-merge, jsonc-merge.</p>

<h3 id="3-for-native-parsers-treehaver-adds-minimal-value">3. For Native Parsers, TreeHaver Adds Minimal Value</h3>

<p>For Prism, Psych, and RBS:</p>
<ul>
  <li>The parser is already part of Ruby or a well-known gem</li>
  <li>There’s no grammar file to find or load</li>
  <li>There’s no security validation needed (no shared library loading)</li>
  <li>There’s no backend switching (Prism only parses Ruby, Psych only parses YAML)</li>
  <li>TreeHaver just adds an extra wrapper layer</li>
</ul>

<h3 id="4-freeze-blocks-are-merge-specific-not-parser-specific">4. Freeze Blocks are Merge-Specific, Not Parser-Specific</h3>

<p>Freeze blocks are a <strong>merge tool</strong>, not a parsing concern:</p>
<ul>
  <li>They’re detected by scanning comments for specific markers</li>
  <li>They affect merge behavior, not parsing behavior</li>
  <li>TreeHaver backends don’t know or care about them</li>
  <li>Each *-merge gem implements them differently based on the comment syntax</li>
</ul>

<hr>

<h2 id="duplication-analysis">Duplication Analysis</h2>

<h3 id="is-there-duplication-between-the-three--merge-gems">Is there duplication between the three *-merge gems?</h3>

<p><strong>Yes, but it’s appropriate:</strong></p>

<ol>
  <li>
<strong>Freeze block detection</strong> - Similar pattern, but:
    <ul>
      <li>prism-merge: Uses Prism’s native comment attachment</li>
      <li>psych-merge: Scans lines for <code># token:freeze</code> markers</li>
      <li>rbs-merge: Scans lines for <code># token:freeze</code> markers</li>
      <li>
<strong>Different enough</strong> that extraction wouldn’t help</li>
    </ul>
  </li>
  <li>
<strong>FileAnalysis structure</strong> - Similar API, but:
    <ul>
      <li>Each has domain-specific methods (e.g., <code>mapping_entries</code>, <code>frozen_nodes</code>, <code>declarations</code>)</li>
      <li>Each has domain-specific signature generation</li>
      <li>
<strong>Intentionally consistent</strong> via <code>Ast::Merge::FileAnalyzable</code>
</li>
    </ul>
  </li>
  <li>
<strong>DebugLogger</strong> - <strong>Could be shared</strong> via ast-merge base
    <ul>
      <li>Currently duplicated across all *-merge gems</li>
      <li>
<strong>Opportunity for consolidation</strong> in ast-merge</li>
    </ul>
  </li>
</ol>

<hr>

<h2 id="recommendations">Recommendations</h2>

<h3 id="-do-keep-prism-merge-psych-merge-rbs-merge-as-is">✅ DO: Keep prism-merge, psych-merge, rbs-merge as-is</h3>

<p><strong>Reasons:</strong></p>
<ol>
  <li>They’re using the parsers correctly and efficiently</li>
  <li>TreeHaver would add complexity without benefit</li>
  <li>Freeze blocks and merge logic are appropriately encapsulated</li>
  <li>No significant duplication exists</li>
</ol>

<h3 id="-do-consider-consolidating-shared-utilities-in-ast-merge">✅ DO: Consider consolidating shared utilities in ast-merge</h3>

<p><strong>Candidates for consolidation:</strong></p>
<ul>
  <li>
<code>DebugLogger</code> - Used by all *-merge gems (same implementation)</li>
  <li>
<code>FreezeNode</code> base class - Shared freeze block pattern</li>
  <li>Comment pattern detection - Used by multiple gems</li>
</ul>

<p><strong>How:</strong></p>
<ul>
  <li>Move <code>DebugLogger</code> to <code>Ast::Merge::DebugLogger</code>
</li>
  <li>Enhance <code>Ast::Merge::FreezeNodeBase</code> with more shared logic</li>
  <li>Create <code>Ast::Merge::CommentScanner</code> for freeze marker detection</li>
</ul>

<h3 id="-dont-create-treehaverbackendsrbs">❌ DON’T: Create TreeHaver::Backends::RBS</h3>

<p><strong>Reasons:</strong></p>
<ol>
  <li>Significant effort with unclear benefit</li>
  <li>RBS::Parser is already well-designed</li>
  <li>No multi-backend scenario exists for RBS</li>
  <li>Would be the only backend created solely for consistency</li>
</ol>

<h3 id="-dont-migrate-prism-merge-or-psych-merge-to-treehaver">❌ DON’T: Migrate prism-merge or psych-merge to TreeHaver</h3>

<p><strong>Reasons:</strong></p>
<ol>
  <li>TreeHaver backends are too thin for merge use cases</li>
  <li>Would lose direct access to Prism::ParseResult and Psych features</li>
  <li>No actual benefit (no alternative backends exist)</li>
  <li>Adds complexity and potential bugs</li>
</ol>

<hr>

<h2 id="dotenv-merge-special-case">dotenv-merge Special Case</h2>

<p><strong>Status:</strong> ✅ Correctly designed</p>

<p>dotenv-merge doesn’t use TreeHaver directly because:</p>
<ol>
  <li>There’s no tree-sitter-dotenv grammar</li>
  <li>Dotenv syntax is simple enough for line-by-line parsing</li>
  <li>It uses <code>ast-merge</code>’s text-merge tooling which is based on TreeHaver indirectly</li>
</ol>

<p><strong>No changes needed.</strong></p>

<hr>

<h2 id="final-verdict">Final Verdict</h2>

<h3 id="summary-table">Summary Table</h3>

<table>
  <thead>
    <tr>
      <th>Gem</th>
      <th>Use TreeHaver?</th>
      <th>Reason</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>toml-merge</strong></td>
      <td>✅ YES</td>
      <td>Tree-sitter grammar, needs backend abstraction</td>
    </tr>
    <tr>
      <td><strong>bash-merge</strong></td>
      <td>✅ YES</td>
      <td>Tree-sitter grammar, needs backend abstraction</td>
    </tr>
    <tr>
      <td><strong>json-merge</strong></td>
      <td>✅ YES</td>
      <td>Tree-sitter grammar, needs backend abstraction</td>
    </tr>
    <tr>
      <td><strong>jsonc-merge</strong></td>
      <td>✅ YES</td>
      <td>Tree-sitter grammar, needs backend abstraction</td>
    </tr>
    <tr>
      <td><strong>markdown-merge</strong></td>
      <td>✅ YES</td>
      <td>Tree-sitter grammars (commonmarker/markly)</td>
    </tr>
    <tr>
      <td><strong>prism-merge</strong></td>
      <td>❌ NO</td>
      <td>Native parser, no alternative backends</td>
    </tr>
    <tr>
      <td><strong>psych-merge</strong></td>
      <td>❌ NO</td>
      <td>Native parser, no alternative backends</td>
    </tr>
    <tr>
      <td><strong>rbs-merge</strong></td>
      <td>❌ NO</td>
      <td>Native parser, no backend exists in TreeHaver</td>
    </tr>
    <tr>
      <td><strong>dotenv-merge</strong></td>
      <td>⚪ N/A</td>
      <td>No grammar exists, uses text-merge</td>
    </tr>
  </tbody>
</table>

<hr>

<h2 id="conclusion">Conclusion</h2>

<p>The transition to TreeHaver for tree-sitter-based gems (toml, bash, json, jsonc, markdown) was <strong>correct and beneficial</strong>.</p>

<p>However, migrating prism-merge, psych-merge, and rbs-merge to use TreeHaver would be:</p>
<ul>
  <li>❌ <strong>Engineering effort</strong> without proportional benefit</li>
  <li>❌ <strong>Additional complexity</strong> for users and maintainers</li>
  <li>❌ <strong>Risk of bugs</strong> from extra wrapping layers</li>
  <li>❌ <strong>No functional improvements</strong> gained</li>
</ul>

<p><strong>Recommendation:</strong> Keep these three gems as-is. They’re well-designed and using their parsers appropriately.</p>

<p><strong>Opportunity:</strong> Consider consolidating <code>DebugLogger</code> and other shared utilities into <code>ast-merge</code> for DRY benefits.</p>

<hr>

<h2 id="action-items">Action Items</h2>

<h3 id="high-priority">High Priority</h3>
<ul class="task-list">
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled><strong>None</strong> - These gems are already well-architected</li>
</ul>

<h3 id="medium-priority">Medium Priority</h3>
<ul class="task-list">
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Consider moving <code>DebugLogger</code> to <code>Ast::Merge::DebugLogger</code> (affects all 11 gems)</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Consider enhancing <code>Ast::Merge::FreezeNodeBase</code> with shared freeze block logic</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Document why these gems don’t use TreeHaver (link to this analysis)</li>
</ul>

<h3 id="low-priority">Low Priority</h3>
<ul class="task-list">
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Evaluate if <code>CommentTracker</code> pattern could be shared across psych-merge and other gems</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Consider if <code>FileAnalyzable</code> module could provide more shared functionality</li>
</ul>

<hr>

<p><strong>Reviewed by:</strong> AI Analysis<br>
<strong>Date:</strong> December 20, 2025<br>
<strong>Status:</strong> Complete</p>
</div></div>

      <div id="footer">
  Generated on Sun Dec 28 16:56:12 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.0).
</div>

    </div>
  </body>
</html>