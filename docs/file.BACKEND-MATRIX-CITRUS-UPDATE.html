<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: BACKEND-MATRIX-CITRUS-UPDATE
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "BACKEND-MATRIX-CITRUS-UPDATE";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: BACKEND-MATRIX-CITRUS-UPDATE</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="backend-matrix-citrus-support-update">Backend-Matrix Citrus Support Update</h1>

<p><strong>Date:</strong> December 18, 2025</p>

<h2 id="summary">Summary</h2>

<p>Added Citrus backend support to <code>bin/backend-matrix</code> script and updated documentation in CONTRIBUTING.md.</p>

<hr>

<h2 id="changes-made">Changes Made</h2>

<h3 id="1-binbackend-matrix-script">1. <code>bin/backend-matrix</code> Script</h3>

<h4 id="added-citrus-to-backend-maps">Added Citrus to Backend Maps</h4>

<pre class="code language-ruby"><code class="language-ruby">GEM_NAMES = {
  &quot;mri&quot; =&gt; &quot;ruby_tree_sitter&quot;,
  &quot;ffi&quot; =&gt; &quot;ffi&quot;,
  &quot;rust&quot; =&gt; &quot;tree_stump&quot;,
  &quot;citrus&quot; =&gt; &quot;citrus&quot;,  # ‚Üê NEW
}.freeze

GEM_REQUIRES = {
  &quot;mri&quot; =&gt; &quot;tree_sitter&quot;,
  &quot;ffi&quot; =&gt; &quot;ffi&quot;,
  &quot;rust&quot; =&gt; &quot;tree_stump&quot;,
  &quot;citrus&quot; =&gt; &quot;citrus&quot;,  # ‚Üê NEW
}.freeze

BACKEND_SYMBOLS = {
  &quot;mri&quot; =&gt; :mri,
  &quot;ffi&quot; =&gt; :ffi,
  &quot;rust&quot; =&gt; :rust,
  &quot;citrus&quot; =&gt; :citrus,   # ‚Üê NEW
}.freeze
</code></pre>

<h4 id="updated-test_backend_with_grammar-function">Updated <code>test_backend_with_grammar</code> Function</h4>

<ul>
  <li>Added Citrus backend handling with special case logic</li>
  <li>Citrus uses different API (no .so files, uses toml-rb grammar)</li>
  <li>Added check for toml-rb gem availability</li>
  <li>Citrus only supports TOML grammar (skips JSON/Bash)</li>
</ul>

<p><strong>Key differences for Citrus:</strong></p>
<pre class="code language-ruby"><code class="language-ruby">if backend_sym == :citrus
  # Check grammar support (TOML only)
  unless grammar == &quot;toml&quot;
    return {status: :skip, message: &quot;Citrus backend only supports TOML grammar&quot;}
  end

  # Load toml-rb grammar using bundler inline (auto-installs if needed)
  require &quot;bundler/inline&quot;
  gemfile do
    source &quot;https://gem.coop&quot;
    gem &quot;toml-rb&quot;
  end

  # Use Citrus-specific Language class
  parser.language = TreeHaver::Backends::Citrus::Language.toml
end
</code></pre>

<h4 id="updated-run_all_permutations-function">Updated <code>run_all_permutations</code> Function</h4>

<ul>
  <li>Changed from 3 backends to 4 backends</li>
  <li>Updated permutation counts:
    <ul>
      <li>1-backend: 3 ‚Üí 4 tests</li>
      <li>2-backend: 6 ‚Üí 12 tests</li>
      <li>3-backend: 6 ‚Üí 24 tests</li>
      <li>4-backend: NEW - 24 tests</li>
      <li><strong>Total: 15 ‚Üí 64 tests</strong></li>
    </ul>
  </li>
</ul>

<h4 id="updated-default-backends">Updated Default Backends</h4>

<p>Changed default backend list to include Citrus:</p>
<pre class="code language-ruby"><code class="language-ruby"># Before
backends = %w[ffi mri rust] if backends.empty?

# After
backends = %w[ffi mri rust citrus] if backends.empty?
</code></pre>

<p>Now running <code>bin/backend-matrix</code> without arguments tests all 4 backends.</p>

<h4 id="updated-usage-documentation">Updated Usage Documentation</h4>

<p>Added Citrus examples:</p>
<pre class="code language-shell"><code class="language-shell">bin/backend-matrix citrus mri ffi               # Citrus before tree-sitter
bin/backend-matrix mri citrus ffi               # Citrus between tree-sitter
bin/backend-matrix --grammar=toml citrus        # Citrus only supports TOML
</code></pre>

<hr>

<h3 id="2-contributingmd-documentation">2. <code>CONTRIBUTING.md</code> Documentation</h3>

<h4 id="backend-overview-section">Backend Overview Section</h4>

<p>Added detailed backend descriptions:</p>
<ul>
  <li>
<strong>MRI</strong>: ruby_tree_sitter (C extension, tree-sitter grammars)</li>
  <li>
<strong>FFI</strong>: Pure Ruby FFI bindings (tree-sitter grammars)</li>
  <li>
<strong>Rust</strong>: tree_stump (Rust extension, tree-sitter grammars)</li>
  <li>
<strong>Citrus</strong>: Pure Ruby parser (TOML only via toml-rb grammar) ‚Üê NEW</li>
</ul>

<p>Added Citrus characteristics:</p>
<ul>
  <li>Uses pure Ruby parsing (no .so files)</li>
  <li>Currently only supports TOML via toml-rb grammar</li>
  <li>Can coexist with tree-sitter backends</li>
  <li>Useful for testing multi-backend scenarios</li>
</ul>

<h4 id="updated-examples">Updated Examples</h4>

<p>Added Citrus-specific test commands:</p>
<pre class="code language-shell"><code class="language-shell"># Test Citrus with tree-sitter backends
bin/backend-matrix citrus mri ffi    # Citrus before tree-sitter
bin/backend-matrix mri citrus ffi    # Citrus between tree-sitter

# Citrus only supports TOML
bin/backend-matrix --grammar=toml citrus
</code></pre>

<h4 id="updated-permutation-counts">Updated Permutation Counts</h4>

<ul>
  <li>Old: ‚ÄúTest all 15 backend combinations (1-backend, 2-backend, 3-backend)‚Äù</li>
  <li>New: ‚ÄúTest all 64 backend combinations (4 backends: 4 1-backend + 12 2-backend + 24 3-backend + 24 4-backend)‚Äù</li>
</ul>

<p>Added note: ‚ÄúCitrus only supports TOML, so JSON/Bash tests will skip for Citrus‚Äù</p>

<h4 id="updated-example-output">Updated Example Output</h4>

<p>Added Citrus rows to compatibility table:</p>
<pre class="code ruby"><code class="ruby">‚îÇ citrus+mri    ‚îÇ ‚úì Fully compatible ‚îÇ       2 ‚îÇ      0 ‚îÇ
‚îÇ citrus+ffi    ‚îÇ ‚úì Fully compatible ‚îÇ       2 ‚îÇ      0 ‚îÇ
‚îÇ citrus+rust   ‚îÇ ‚úì Fully compatible ‚îÇ       2 ‚îÇ      0 ‚îÇ
</code></pre>

<h4 id="added-citrus-requirements-section">Added Citrus Requirements Section</h4>

<pre class="code language-markdown"><code class="language-markdown">**For Citrus backend:**
- Requires the `toml-rb` gem (pure Ruby TOML parser)
- No environment variables needed (doesn&#39;t use .so files)
- Only supports TOML grammar
</code></pre>

<hr>

<h2 id="key-behaviors">Key Behaviors</h2>

<h3 id="citrus-backend-characteristics">Citrus Backend Characteristics</h3>

<ol>
  <li>
<strong>Grammar Support</strong>: TOML only (via toml-rb)</li>
  <li>
<strong>No .so Files</strong>: Uses pure Ruby grammar instead</li>
  <li>
<strong>Compatibility</strong>: Can coexist with all tree-sitter backends</li>
  <li>
<strong>Dependencies</strong>: Requires <code>citrus</code> gem and <code>toml-rb</code> gem</li>
  <li>
<strong>Auto-Installation</strong>: Script uses bundler inline to automatically install <code>toml-rb</code> when needed</li>
</ol>

<h3 id="test-behavior">Test Behavior</h3>

<p>When testing with Citrus:</p>
<ul>
  <li>
<strong>TOML grammar</strong>: Citrus will parse successfully</li>
  <li>
<strong>JSON/Bash grammars</strong>: Citrus will skip with message ‚ÄúCitrus backend only supports TOML grammar‚Äù</li>
  <li>
<strong>Multi-backend chains</strong>: Citrus can be mixed with MRI/FFI/Rust backends</li>
</ul>

<h3 id="error-handling">Error Handling</h3>

<p>The script gracefully handles:</p>
<ul>
  <li>Missing <code>toml-rb</code> gem: Automatically installs via bundler inline</li>
  <li>Failed <code>toml-rb</code> installation: Returns skip status with error message</li>
  <li>Wrong grammar for Citrus: Returns skip status</li>
  <li>Citrus availability check: Uses <code>TreeHaver::Backends::Citrus.available?</code>
</li>
</ul>

<hr>

<h2 id="testing-matrix-expansion">Testing Matrix Expansion</h2>

<h3 id="before-3-backends">Before (3 backends)</h3>
<ul>
  <li>1-backend: 3 tests</li>
  <li>2-backend: 6 permutations</li>
  <li>3-backend: 6 permutations</li>
  <li><strong>Total: 15 tests</strong></li>
</ul>

<h3 id="after-4-backends">After (4 backends)</h3>
<ul>
  <li>1-backend: 4 tests</li>
  <li>2-backend: 12 permutations (4P2)</li>
  <li>3-backend: 24 permutations (4P3)</li>
  <li>4-backend: 24 permutations (4P4)</li>
  <li><strong>Total: 64 tests</strong></li>
</ul>

<hr>

<h2 id="files-modified">Files Modified</h2>

<ol>
  <li>
<strong><code>bin/backend-matrix</code></strong> (990 lines)
    <ul>
      <li>Added Citrus to backend maps</li>
      <li>Updated <code>test_backend_with_grammar</code> with Citrus logic</li>
      <li>Updated <code>run_all_permutations</code> to include 4-backend tests</li>
      <li>Updated usage documentation</li>
      <li>
<strong>Fixed default backends</strong>: Changed from <code>%w[ffi mri rust]</code> to <code>%w[ffi mri rust citrus]</code>
</li>
    </ul>
  </li>
  <li>
<strong><code>CONTRIBUTING.md</code></strong> (349 lines)
    <ul>
      <li>Updated backend overview section</li>
      <li>Added Citrus-specific examples</li>
      <li>Updated permutation counts</li>
      <li>Added Citrus requirements section</li>
      <li>Updated example output tables</li>
    </ul>
  </li>
</ol>

<hr>

<h2 id="usage-examples">Usage Examples</h2>

<h3 id="basic-citrus-testing">Basic Citrus Testing</h3>
<pre class="code language-shell"><code class="language-shell"># Test Citrus alone with TOML
bin/backend-matrix citrus --grammar=toml

# Test all backends including Citrus
bin/backend-matrix mri ffi rust citrus
</code></pre>

<h3 id="citrus-in-multi-backend-chains">Citrus in Multi-Backend Chains</h3>
<pre class="code language-shell"><code class="language-shell"># Citrus before tree-sitter backends
bin/backend-matrix citrus mri ffi

# Citrus between tree-sitter backends
bin/backend-matrix mri citrus rust

# All permutations with Citrus
bin/backend-matrix --all-permutations
</code></pre>

<h3 id="cross-grammar-with-citrus">Cross-Grammar with Citrus</h3>
<pre class="code language-shell"><code class="language-shell"># Citrus uses TOML, others use JSON
bin/backend-matrix --cross-grammar --grammars=json,toml
</code></pre>

<hr>

<h2 id="expected-behavior">Expected Behavior</h2>

<h3 id="successful-tests">Successful Tests</h3>
<ul>
  <li>‚úÖ Citrus + TOML: Parses successfully</li>
  <li>‚úÖ Citrus + MRI: Can coexist</li>
  <li>‚úÖ Citrus + FFI: Can coexist</li>
  <li>‚úÖ Citrus + Rust: Can coexist</li>
</ul>

<h3 id="skip-scenarios">Skip Scenarios</h3>
<ul>
  <li>‚ö†Ô∏è Citrus + JSON: Skips (not supported)</li>
  <li>‚ö†Ô∏è Citrus + Bash: Skips (not supported)</li>
  <li>‚ö†Ô∏è Citrus without toml-rb: Auto-installs via bundler inline (or skips if installation fails)</li>
</ul>

<h3 id="mixed-chains">Mixed Chains</h3>
<pre class="code ruby"><code class="ruby">mri+json ‚Üí citrus+toml ‚Üí ffi+bash
  ‚úì         ‚úì              ‚úì
  
All can coexist because:
- Different backends don&#39;t conflict
- Citrus doesn&#39;t conflict with tree-sitter backends
- Each uses appropriate grammar
</code></pre>

<hr>

<h2 id="benefits">Benefits</h2>

<ol>
  <li>
<strong>Broader Testing</strong>: Now covers pure Ruby backend in compatibility matrix</li>
  <li>
<strong>Multi-Backend Validation</strong>: Tests Citrus coexistence with tree-sitter backends</li>
  <li>
<strong>Documentation</strong>: Clear guidance on Citrus limitations and usage</li>
  <li>
<strong>Future-Proof</strong>: Framework ready for additional pure Ruby backends</li>
</ol>

<hr>

<h2 id="limitations">Limitations</h2>

<h3 id="citrus-backend">Citrus Backend</h3>
<ul>
  <li>Only TOML grammar supported currently</li>
  <li>Requires separate toml-rb gem</li>
  <li>May be slower than native tree-sitter backends</li>
</ul>

<h3 id="testing">Testing</h3>
<ul>
  <li>Citrus tests will skip for JSON/Bash/JSONC grammars</li>
  <li>Fewer total combinations for Citrus (TOML only)</li>
  <li>Cross-grammar testing limited by single grammar support</li>
</ul>

<hr>

<h2 id="future-enhancements">Future Enhancements</h2>

<p>Possible additions:</p>
<ul>
  <li>More Citrus grammars (Finitio, Dhall as shown in examples)</li>
  <li>Support for testing language-specific backends (Prism, Psych, Commonmarker, Markly)</li>
  <li>Automated CI testing of all 64 combinations</li>
  <li>Performance comparison between Citrus and tree-sitter for TOML</li>
</ul>

<hr>

<h2 id="result">Result</h2>

<p>‚úÖ Citrus backend fully integrated into backend-matrix testing framework<br>
‚úÖ Documentation updated to reflect 4-backend support<br>
‚úÖ Test matrix expanded from 15 to 64 combinations<br>
‚úÖ Clear guidance on Citrus usage and limitations</p>

<p>The backend-matrix script now comprehensively tests all available TreeHaver backends! üéâ</p>
</div></div>

      <div id="footer">
  Generated on Sun Dec 28 16:22:19 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.0).
</div>

    </div>
  </body>
</html>