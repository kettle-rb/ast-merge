<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: TREEHAVER-MIGRATION-GUIDE
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "TREEHAVER-MIGRATION-GUIDE";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: TREEHAVER-MIGRATION-GUIDE</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="treehaver-migration-quick-reference">TreeHaver Migration Quick Reference</h1>

<h2 id="before--after-comparison">Before &amp; After Comparison</h2>

<h3 id="finding-grammar-paths">Finding Grammar Paths</h3>

<h4 id="-old-way-dont-do-this-anymore">❌ OLD WAY (Don’t do this anymore)</h4>
<pre class="code language-ruby"><code class="language-ruby">PARSER_SEARCH_PATHS = [
  &quot;/usr/lib/libtree-sitter-toml.so&quot;,
  &quot;/usr/lib64/libtree-sitter-toml.so&quot;,
  &quot;/usr/local/lib/libtree-sitter-toml.so&quot;,
  &quot;/opt/homebrew/lib/libtree-sitter-toml.dylib&quot;,
].freeze

def self.find_parser_path
  env_path = ENV[&quot;TREE_SITTER_TOML_PATH&quot;]
  return env_path if env_path &amp;&amp; File.exist?(env_path)
  PARSER_SEARCH_PATHS.find { |path| File.exist?(path) }
end
</code></pre>

<h4 id="-new-way-treehaver">✅ NEW WAY (TreeHaver)</h4>
<pre class="code language-ruby"><code class="language-ruby">def self.find_parser_path
  return unless defined?(TreeHaver::GrammarFinder)
  TreeHaver::GrammarFinder.new(:toml).find_library_path
end
</code></pre>

<hr>

<h3 id="loading-and-parsing">Loading and Parsing</h3>

<h4 id="-old-way-direct-treesitter-api">❌ OLD WAY (Direct TreeSitter API)</h4>
<pre class="code language-ruby"><code class="language-ruby">def parse_toml
  unless @parser_path &amp;&amp; File.exist?(@parser_path)
    raise &quot;Parser not found&quot;
  end

  language = TreeSitter::Language.load(&quot;toml&quot;, @parser_path)
  parser = TreeSitter::Parser.new
  parser.language = language
  @ast = parser.parse_string(nil, @source)
end
</code></pre>

<h4 id="-new-way-treehaver-api">✅ NEW WAY (TreeHaver API)</h4>
<pre class="code language-ruby"><code class="language-ruby">def parse_toml
  unless defined?(TreeHaver)
    @errors &lt;&lt; &quot;TreeHaver not available&quot;
    return
  end

  language = if @parser_path &amp;&amp; File.exist?(@parser_path)
    TreeHaver::Language.from_library(@parser_path, symbol: &quot;tree_sitter_toml&quot;, name: &quot;toml&quot;)
  elsif TreeHaver::Language.respond_to?(:toml)
    TreeHaver::Language.toml
  else
    @errors &lt;&lt; TreeHaver::GrammarFinder.new(:toml).not_found_message
    return
  end

  parser = TreeHaver::Parser.new
  parser.language = language
  @ast = parser.parse(@source)
end
</code></pre>

<hr>

<h2 id="type-changes">Type Changes</h2>

<h3 id="documentation">Documentation</h3>

<h4 id="-old">❌ OLD</h4>
<pre class="code language-ruby"><code class="language-ruby"># @param node [TreeSitter::Node] The node
# @return [TreeSitter::Tree] The tree
</code></pre>

<h4 id="-new">✅ NEW</h4>
<pre class="code language-ruby"><code class="language-ruby"># @param node [TreeHaver::Node] The node
# @return [TreeHaver::Tree] The tree
</code></pre>

<h3 id="exception-handling">Exception Handling</h3>

<h4 id="-old-1">❌ OLD</h4>
<pre class="code language-ruby"><code class="language-ruby">rescue TreeSitter::Error =&gt; e
  # handle error
end
</code></pre>

<h4 id="-new-1">✅ NEW</h4>
<pre class="code language-ruby"><code class="language-ruby">rescue TreeHaver::Error =&gt; e
  # handle error
end
</code></pre>

<hr>

<h2 id="environment-variables">Environment Variables</h2>

<h3 id="-still-work-the-same">✅ STILL WORK THE SAME</h3>
<pre class="code language-bash"><code class="language-bash"># All these still work - no changes needed!
export TREE_SITTER_TOML_PATH=/path/to/libtree-sitter-toml.so
export TREE_SITTER_BASH_PATH=/path/to/libtree-sitter-bash.so
export TREE_SITTER_JSON_PATH=/path/to/libtree-sitter-json.so
export TREE_SITTER_JSONC_PATH=/path/to/libtree-sitter-json.so
</code></pre>

<hr>

<h2 id="custom-parser-paths">Custom Parser Paths</h2>

<h3 id="-still-work-the-same-1">✅ STILL WORK THE SAME</h3>
<pre class="code language-ruby"><code class="language-ruby"># This still works - no changes needed!
analysis = FileAnalysis.new(
  source,
  parser_path: &quot;/custom/path/libtree-sitter-toml.so&quot;
)
</code></pre>

<hr>

<h2 id="pattern-for-new-gems">Pattern for New Gems</h2>

<h3 id="recommended-structure">Recommended Structure</h3>

<pre class="code language-ruby"><code class="language-ruby">module MyLanguage
  module Merge
    class FileAnalysis
      include Ast::Merge::FileAnalyzable

      # @return [TreeHaver::Tree, nil] Parsed AST
      attr_reader :ast

      class &lt;&lt; self
        # Find the parser library path using TreeHaver::GrammarFinder
        # @return [String, nil] Path to the parser library or nil if not found
        def find_parser_path
          return unless defined?(TreeHaver::GrammarFinder)
          TreeHaver::GrammarFinder.new(:mylang).find_library_path
        end
      end

      def initialize(source, parser_path: nil)
        @source = source
        @parser_path = parser_path || self.class.find_parser_path
        parse_source
      end

      private

      def parse_source
        unless defined?(TreeHaver)
          @errors &lt;&lt; &quot;TreeHaver not available. Install tree_haver gem.&quot;
          return
        end

        language = if @parser_path &amp;&amp; File.exist?(@parser_path)
          TreeHaver::Language.from_library(
            @parser_path, 
            symbol: &quot;tree_sitter_mylang&quot;, 
            name: &quot;mylang&quot;
          )
        elsif TreeHaver::Language.respond_to?(:mylang)
          TreeHaver::Language.mylang
        else
          @errors &lt;&lt; TreeHaver::GrammarFinder.new(:mylang).not_found_message
          return
        end

        parser = TreeHaver::Parser.new
        parser.language = language
        @ast = parser.parse(@source)
      end
    end
  end
end
</code></pre>

<hr>

<h2 id="checklist-for-new-gems">Checklist for New Gems</h2>

<p>When creating a new *-merge gem:</p>

<ul class="task-list">
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Use <code>TreeHaver::GrammarFinder</code> for path discovery</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Use <code>TreeHaver::Parser</code> for parsing</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Use <code>TreeHaver::Language</code> for language loading</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Document return types as <code>TreeHaver::Node</code> and <code>TreeHaver::Tree</code>
</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Support custom <code>parser_path:</code> parameter</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Let TreeHaver handle ENV variables automatically</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Include helpful error messages via <code>GrammarFinder#not_found_message</code>
</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Add <code>tree_haver</code> as a dependency in gemspec</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>NO hardcoded path lists</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>NO manual ENV variable checking</li>
  <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>NO fallback path searching</li>
</ul>

<hr>

<h2 id="common-mistakes-to-avoid">Common Mistakes to Avoid</h2>

<h3 id="-dont-hardcode-paths">❌ DON’T: Hardcode Paths</h3>
<pre class="code language-ruby"><code class="language-ruby"># NO!
PATHS = [&quot;/usr/lib/...&quot;, &quot;/usr/local/lib/...&quot;]
</code></pre>

<h3 id="-dont-check-env-variables-manually">❌ DON’T: Check ENV Variables Manually</h3>
<pre class="code language-ruby"><code class="language-ruby"># NO!
env_path = ENV[&quot;TREE_SITTER_MYLANG_PATH&quot;]
return env_path if env_path &amp;&amp; File.exist?(env_path)
</code></pre>

<h3 id="-dont-use-old-treesitter-api">❌ DON’T: Use Old TreeSitter API</h3>
<pre class="code language-ruby"><code class="language-ruby"># NO!
TreeSitter::Language.load(&quot;mylang&quot;, path)
parser.parse_string(nil, source)
</code></pre>

<h3 id="-do-let-treehaver-handle-everything">✅ DO: Let TreeHaver Handle Everything</h3>
<pre class="code language-ruby"><code class="language-ruby"># YES!
TreeHaver::GrammarFinder.new(:mylang).find_library_path
TreeHaver::Language.from_library(path, symbol: &quot;tree_sitter_mylang&quot;)
parser.parse(source)
</code></pre>

<hr>

<h2 id="benefits-summary">Benefits Summary</h2>

<table>
  <thead>
    <tr>
      <th>Feature</th>
      <th>Old Way</th>
      <th>TreeHaver Way</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Path Discovery</strong></td>
      <td>Manual, duplicated</td>
      <td>Automatic, centralized</td>
    </tr>
    <tr>
      <td><strong>Security</strong></td>
      <td>None</td>
      <td>Path validation built-in</td>
    </tr>
    <tr>
      <td><strong>Platform Support</strong></td>
      <td>Manual extension handling</td>
      <td>Automatic (.so/.dylib/.dll)</td>
    </tr>
    <tr>
      <td><strong>Backend Support</strong></td>
      <td>MRI only</td>
      <td>MRI, Rust, FFI, Java, Citrus</td>
    </tr>
    <tr>
      <td><strong>Error Messages</strong></td>
      <td>Manual, inconsistent</td>
      <td>Helpful, context-aware</td>
    </tr>
    <tr>
      <td><strong>Maintainability</strong></td>
      <td>Low (duplicated code)</td>
      <td>High (single source)</td>
    </tr>
    <tr>
      <td><strong>Code Lines</strong></td>
      <td>~40 per gem</td>
      <td>~5 per gem</td>
    </tr>
  </tbody>
</table>

<hr>

<h2 id="questions">Questions?</h2>

<p><strong>Q: Do I need to change my ENV variables?</strong>  <br>
A: No! They work exactly the same.</p>

<p><strong>Q: Do I need to change custom parser paths?</strong>  <br>
A: No! The <code>parser_path:</code> parameter still works.</p>

<p><strong>Q: Will this break my code?</strong>  <br>
A: Only if you catch <code>TreeSitter::Error</code> - change to <code>TreeHaver::Error</code>.</p>

<p><strong>Q: Can I still use MRI’s ruby_tree_sitter?</strong>  <br>
A: Yes! TreeHaver uses it automatically on MRI.</p>

<p><strong>Q: What if TreeHaver isn’t available?</strong>  <br>
A: Your code should check <code>defined?(TreeHaver)</code> and show a helpful error.</p>

<p><strong>Q: Do I need to update tests?</strong>  <br>
A: Possibly - check for <code>TreeSitter</code> type references.</p>

<hr>

<h2 id="resources">Resources</h2>

<ul>
  <li>
<strong>Full Analysis</strong>: See <code>BACKEND-GRAMMAR-DUPLICATION-ANALYSIS.md</code>
</li>
  <li>
<strong>Complete Documentation</strong>: See <code>BACKEND-TRANSITION-COMPLETE.md</code>
</li>
  <li>
<strong>Executive Summary</strong>: See <code>TREEHAVER-TRANSITION-SUMMARY.md</code>
</li>
  <li>
<strong>TreeHaver Documentation</strong>: See <code>vendor/tree_haver/README.md</code>
</li>
  <li>
<strong>TreeHaver GrammarFinder</strong>: See <code>vendor/tree_haver/lib/tree_haver/grammar_finder.rb</code>
</li>
</ul>

<hr>

<p><strong>Last Updated:</strong> December 20, 2025</p>
</div></div>

      <div id="footer">
  Generated on Sun Dec 28 18:06:57 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.0).
</div>

    </div>
  </body>
</html>