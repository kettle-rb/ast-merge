# Gem Family Section Update Recipe
#
# This recipe updates the "*-merge Gem Family" section in all README files
# that already contain it. It uses the GEM_FAMILY_SECTION.md template.
#
# Usage:
#   bin/ast-merge-recipe .merge-recipes/gem_family_section.yml --dry-run
#   bin/ast-merge-recipe .merge-recipes/gem_family_section.yml

name: gem_family_section
description: Update gem family section in README files

# Template file containing the section content
template: ../GEM_FAMILY_SECTION.md

# Target files to process (globs relative to recipe location)
targets:
  - "../README.md"
  - "../vendor/*/README.md"

# How to find the injection point in destination files
injection:
  # The anchor identifies where the section starts
  anchor:
    type: heading
    # IMPORTANT: The .text method returns plain text WITHOUT markdown formatting.
    # Inline formatting like backticks, bold, italic, and links are stripped.
    #
    # In the markdown source:  ### The `*-merge` Gem Family
    # The .text returns:       "The *-merge Gem Family\n"
    #
    # So we match against plain text, not the markdown source.
    # Use ^ to anchor at start if you need exact heading match.
    text: "/^The \\*-merge Gem Family/"

  # Position: replace means we replace from anchor to boundary
  position: replace

  # Boundary defines where the section ends
  # same_or_shallower: true means "stop at next node at same or higher tree level"
  # This is language-agnostic - works for any hierarchical structure
  boundary:
    type: heading
    same_or_shallower: true

# Merge behavior
merge:
  # For matched nodes, prefer template content
  preference: template

  # Replace the entire section with template content
  # This is the most reliable behavior - the template completely replaces
  # whatever is in the destination's section
  replace_mode: true

  # Note: With replace_mode: true, the following options are NOT used:
  # - add_missing (no node-by-node comparison)
  # - signature_generator (no node-by-node matching)
  # - node_typing (no per-type preference handling)
  # - match_refiner (no fuzzy matching)
  #
  # The template completely replaces the section content.
  # These options only apply when replace_mode: false (intelligent merge mode).

# What to do when a target file doesn't have the anchor
# skip = don't modify files without the section
# add = add the section (not implemented yet)
# error = fail the recipe
when_missing: skip

